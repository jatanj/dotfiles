class AddIdeaPlugin implements Plugin<Gradle> {
    private static final String IDEA_PLUGIN_CLASS = 'org.gradle.plugins.ide.idea.IdeaPlugin'
    private boolean added = false

    void apply(Gradle gradle) {
        gradle.allprojects { project ->
            project.with {
                def p = plugins.find { IDEA_PLUGIN_CLASS.equals(it.class.name) }
                if (!added && !p) {
                    rootProject.apply plugin: 'idea'
                    added = true
                }
            }
        }
    }
}

apply plugin: AddIdeaPlugin
